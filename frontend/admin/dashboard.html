<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CartLink System</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="dashboard.html" class="logo"><i class="bi bi-speedometer2"></i> CartLink Admin</a>
            <ul class="nav-links">
                <li><a href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li><a href="products.html"><i class="bi bi-box-seam"></i> Products</a></li>
                <li><a href="orders.html"><i class="bi bi-bag-check"></i> Orders</a></li>
                <li><a href="categories.html"><i class="bi bi-tags"></i> Categories</a></li>
                <li><a href="#" id="logout-btn"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="container" style="margin-top: 2rem; margin-bottom: 3rem;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold"><i class="bi bi-speedometer2"></i> Dashboard</h1>
            <span class="text-muted">Welcome back, Admin!</span>
        </div>

        <!-- Metrics Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2>Total Orders</h2>
                            <p class="value" id="total-orders">0</p>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">
                            <i class="bi bi-cart-check"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2>Total Revenue</h2>
                            <p class="value" id="total-revenue">$0</p>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card warning">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2>Total Products</h2>
                            <p class="value" id="total-products">0</p>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders and Low Stock -->
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-body">
                        <h2 class="mb-4"><i class="bi bi-clock-history"></i> Recent Orders</h2>
                        <div id="recent-orders"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card">
                    <div class="card-body">
                        <h2 class="mb-4"><i class="bi bi-exclamation-triangle"></i> Low Stock Products</h2>
                        <div id="low-stock"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        // Check if user is admin
        if (!Auth.isAuthenticated() || !Auth.isAdmin()) {
            showAlert('Unauthorized access', 'error');
            setTimeout(() => {
                window.location.href = '../customer/login.html';
            }, 2000);
        }

        async function loadDashboardData() {
            showLoading();
            
            // Load orders
            const ordersResponse = await API.get('/orders/list.php');
            // Load products
            const productsResponse = await API.get('/products/list.php');
            
            hideLoading();
            
            if (ordersResponse.success) {
                const orders = ordersResponse.data;
                document.getElementById('total-orders').textContent = orders.length;
                
                // Calculate total revenue
                const revenue = orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
                document.getElementById('total-revenue').textContent = formatCurrency(revenue);
                
                // Display recent orders
                const recentOrders = orders.slice(0, 5);
                const recentOrdersDiv = document.getElementById('recent-orders');
                
                if (recentOrders.length > 0) {
                    recentOrdersDiv.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Status</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentOrders.map(order => `
                                        <tr>
                                            <td><strong>${order.reference_number}</strong></td>
                                            <td>${order.customer_name}</td>
                                            <td>
                                                <span class="badge bg-${getStatusBadgeClass(order.status)}">
                                                    ${capitalizeWords(order.status)}
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold">$${parseFloat(order.total_amount).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    recentOrdersDiv.innerHTML = '<p class="text-muted text-center">No orders yet</p>';
                }
            }
            
            if (productsResponse.success) {
                const products = productsResponse.data;
                document.getElementById('total-products').textContent = products.length;
                
                // Display low stock products
                const lowStock = products.filter(p => p.stock < 10).slice(0, 5);
                const lowStockDiv = document.getElementById('low-stock');
                
                if (lowStock.length > 0) {
                    lowStockDiv.innerHTML = `
                        <div class="list-group list-group-flush">
                            ${lowStock.map(product => `
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <div class="fw-bold">${product.name}</div>
                                        <small class="text-muted">${product.category_name || 'Uncategorized'}</small>
                                    </div>
                                    <span class="badge ${product.stock === 0 ? 'bg-danger' : 'bg-warning text-dark'} rounded-pill">
                                        ${product.stock} left
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    lowStockDiv.innerHTML = '<p class="text-muted text-center">All products have sufficient stock</p>';
                }
            }
        }

        function getStatusBadgeClass(status) {
            const statusClasses = {
                'pending': 'warning',
                'confirmed': 'info',
                'preparing': 'primary',
                'out_for_delivery': 'primary',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return statusClasses[status] || 'secondary';
        }

        loadDashboardData();
    </script>
</body>
</html>
