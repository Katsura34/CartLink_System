<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - CartLink System</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="logo">ðŸ›’ CartLink</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="cart.html">Cart <span class="cart-badge">0</span></a></li>
                <li id="auth-links"></li>
            </ul>
        </nav>
    </header>

    <div class="container" style="margin-top: 2rem;">
        <h1 class="mb-3">My Orders</h1>

        <div id="orders-container"></div>
        
        <div id="no-orders" class="card text-center" style="display: none;">
            <h2>No orders yet</h2>
            <p>Start shopping to create your first order!</p>
            <a href="products.html" class="btn btn-primary">Browse Products</a>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="order-details"></div>
        </div>
    </div>

    <script src="../assets/js/main.js"></script>
    <script>
        // Check if user is authenticated
        if (!Auth.isAuthenticated()) {
            showAlert('Please login to view orders', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        }

        // Update navigation
        const authLinks = document.getElementById('auth-links');
        const user = Auth.getUser();
        authLinks.innerHTML = `
            <li><a href="orders.html">My Orders</a></li>
            <li><a href="#" id="logout-btn">Logout (${user.username})</a></li>
        `;

        async function loadOrders() {
            showLoading();
            const response = await API.get('/orders/list.php');
            hideLoading();
            
            const container = document.getElementById('orders-container');
            const noOrders = document.getElementById('no-orders');
            
            if (response.success && response.data.length > 0) {
                noOrders.style.display = 'none';
                
                container.innerHTML = response.data.map(order => `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3>Order #${order.reference_number}</h3>
                                <p style="color: var(--text-light); font-size: 0.875rem; margin-top: 0.5rem;">
                                    ${formatDate(order.created_at)}
                                </p>
                            </div>
                            <span class="status-badge ${getStatusClass(order.status)}">
                                ${capitalizeWords(order.status)}
                            </span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 0.875rem; color: var(--text-light);">Total Amount</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                                    $${parseFloat(order.total_amount).toFixed(2)}
                                </p>
                            </div>
                            <button onclick="viewOrder(${order.id})" class="btn btn-primary">
                                View Details
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Highlight order if specified in URL
                const urlParams = new URLSearchParams(window.location.search);
                const highlightId = urlParams.get('highlight');
                if (highlightId) {
                    const order = response.data.find(o => o.id == highlightId);
                    if (order) {
                        viewOrder(highlightId);
                    }
                }
            } else {
                container.innerHTML = '';
                noOrders.style.display = 'block';
            }
        }

        async function viewOrder(orderId) {
            showLoading();
            const response = await API.get(`/orders/get.php?id=${orderId}`);
            hideLoading();
            
            if (response.success) {
                const order = response.data;
                const modal = document.getElementById('order-modal');
                const details = document.getElementById('order-details');
                
                details.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <h3>Order #${order.reference_number}</h3>
                        <span class="status-badge ${getStatusClass(order.status)}">
                            ${capitalizeWords(order.status)}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p><strong>Order Date:</strong> ${formatDate(order.created_at)}</p>
                        <p><strong>Delivery Address:</strong> ${order.delivery_address}</p>
                        <p><strong>Contact Phone:</strong> ${order.contact_phone}</p>
                        ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    </div>
                    
                    <h4 style="margin-bottom: 1rem;">Order Items</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.product_name}</td>
                                    <td>$${parseFloat(item.product_price).toFixed(2)}</td>
                                    <td>${item.quantity}</td>
                                    <td>$${parseFloat(item.subtotal).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <h3>Total: $${parseFloat(order.total_amount).toFixed(2)}</h3>
                    </div>
                `;
                
                modal.classList.add('active');
            } else {
                showAlert('Failed to load order details', 'error');
            }
        }

        function closeModal() {
            document.getElementById('order-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-modal') {
                closeModal();
            }
        });

        loadOrders();
    </script>
</body>
</html>
